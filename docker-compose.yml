version: '3.8'

services:
  comfyui:
    image: ${COMFYUI_IMAGE:-ghcr.io/yanwenkun/comfyui-docker:cpu}
    container_name: comfyui-frontend
    ports:
      - "${COMFYUI_PORT:-8188}:8188"
    volumes:
      # Dados persistentes
      - ./data/output:/app/output
      - ./data/input:/app/input
      - ./data/workflows:/app/user
      - ./data/custom_nodes:/app/custom_nodes
    environment:
      # ═══════════════════════════════════════════════════════════
      # CONFIGURAÇÕES DO COMFYUI (edite no Coolify → Environment)
      # ═══════════════════════════════════════════════════════════

      # Argumentos CLI do ComfyUI
      # Default: --cpu --listen --preview-method auto
      # Se tiver GPU: --listen --preview-method auto
      - CLI_ARGS=${COMFYUI_CLI_ARGS:---cpu --listen --preview-method auto}

      # ═══════════════════════════════════════════════════════════
      # CONFIGURAÇÕES VAST.AI (para processamento GPU sob demanda)
      # ═══════════════════════════════════════════════════════════

      # Sua API Key do Vast.ai (obtenha em vast.ai/console/account)
      - VASTAI_API_KEY=${VASTAI_API_KEY:-}

      # Preço máximo por hora que você aceita pagar (USD)
      - VASTAI_MAX_PRICE=${VASTAI_MAX_PRICE:-0.50}

      # GPUs preferidas (separadas por vírgula)
      - VASTAI_PREFERRED_GPUS=${VASTAI_PREFERRED_GPUS:-RTX 3090,RTX 4090,RTX A5000}

      # ═══════════════════════════════════════════════════════════
      # CONFIGURAÇÕES S3 (opcional - para salvar resultados na nuvem)
      # ═══════════════════════════════════════════════════════════

      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL:-}
      - S3_REGION=${S3_REGION:-auto}

    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8188/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Limites de recursos (ajuste conforme sua VPS)
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-2G}
        reservations:
          memory: ${MEMORY_RESERVATION:-512M}

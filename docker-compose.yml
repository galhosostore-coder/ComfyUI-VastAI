version: '3.8'

services:
  comfyui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: comfyui-frontend
    ports:
      - "${COMFYUI_PORT:-8188}:8188"
    volumes:
      # Dados persistentes
      - ./data/output:/app/output
      - ./data/input:/app/input
      - ./data/workflows:/app/user
      - ./data/custom_nodes:/app/custom_nodes
    environment:
      # ═══════════════════════════════════════════════════════════
      # CONFIGURAÇÕES VAST.AI (para processamento GPU sob demanda)
      # ═══════════════════════════════════════════════════════════

      # Sua API Key do Vast.ai (obtenha em vast.ai/console/account)
      - VASTAI_API_KEY=${VASTAI_API_KEY:-}

      # Preço máximo por hora que você aceita pagar (USD)
      - VASTAI_MAX_PRICE=${VASTAI_MAX_PRICE:-0.50}

      # GPUs preferidas (separadas por vírgula)
      - VASTAI_PREFERRED_GPUS=${VASTAI_PREFERRED_GPUS:-RTX 3090,RTX 4090,RTX A5000}

      # ═══════════════════════════════════════════════════════════
      # CONFIGURAÇÕES S3 (opcional - para salvar resultados na nuvem)
      # ═══════════════════════════════════════════════════════════

      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL:-}
      - S3_REGION=${S3_REGION:-auto}

    restart: unless-stopped

    # Limites de recursos (ajuste conforme sua VPS)
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-4G}
        reservations:
          memory: ${MEMORY_RESERVATION:-1G}
